!!! info ""

    参考链接:
    
    [矩阵求导公式的数学推导（矩阵求导——进阶篇）](https://zhuanlan.zhihu.com/p/288541909)


## 一. 矩阵的迹

### 1、定义

$n \times n$的**方阵** $A_{n \times n}$ 的主对角线元素之和就叫做矩阵 $A$ 的迹(trace), 记作 $tr(A)$ , 即: 

$\pmb{A}_{n \times n} = \begin{bmatrix} a_{11} & a_{12} & \cdots & a_{1n} \\ a_{21} & a_{22} & \cdots & a_{2n} \\ \vdots & \vdots & \ddots & \vdots \\ a_{n1} & a_{n2} & \cdots & a_{nn} \\ \end{bmatrix}_{n \times n}\\\\$

$A$的迹为: 

$$tr(\pmb{A})=a_{11} + a_{22} + \cdots + a_{nn} = \sum_{i=1}^n{a_{ii}} \tag{1}$$

注意：只有**方阵**才有迹。

### 2、一些性质(建议熟记)
#### 2.1 标量的迹
对于一个标量 $x$ ,可以看成是 $1 \times 1$ 的矩阵，它的迹就是它自己。

$$x=tr(x)\\\\ \tag{2}$$

#### 2.2 线性法则
相加再求迹等于求迹再相加，标量提外面

$$tr(c_1A+c_2B)=c_1tr(A)+c_2tr(B)\\\\ \tag{3}$$

其中, $c_1,c_2$为标量。

**证明：**

$$
\begin{align} tr(c_1\pmb{A}+c_2\pmb{B})  &= tr \begin{bmatrix} c_1a_{11}+c_2b_{11} & c_1a_{12}+c_2b_{12} & \cdots & c_1a_{1n}+c_2b_{1n} \\ c_1a_{21}+c_2b_{21} & c_1a_{22}+c_2b_{22} & \cdots & c_1a_{2n}+c_2b_{2n} \\ \vdots & \vdots & \ddots & \vdots \\ c_1a_{n1}+c_2b_{n1} & c_1a_{n2}+c_2b_{n2} & \cdots & c_1a_{nn}+c_2b_{nn} \\ \end{bmatrix}  \\\\  &= (c_1a_{11}+c_2b_{11})+(c_1a_{22}+c_2b_{22})+\cdots + (c_1a_{nn}+c_2b_{nn})   \\\\  &= c_1(a_{11}+a_{22}+\cdots+a_{nn}) + c_2(b_{11}+b_{22}+\cdots+b_{nn})  \\\\  &= c_1tr(\pmb{A})+c_2tr(\pmb{B})  \end{align} \\\\ \tag{4}
$$

**证毕。**

#### 2.3 转置

转置的迹等于原矩阵的迹

$$tr(A^T)=tr(A)\\\\ \tag{5}$$

**证明：**

因为转置不会改变主对角线的元素，故成立。

**证毕。**

#### 2.4 乘积的迹的本质

对于两个阶数都是 $m \times n$ 的矩阵 $A_{m \times n}, B_{m \times n}$ 其中一个矩阵乘以（左乘右乘都可以）另一个矩阵的转置的迹，本质是 $A_{m \times n}, B_{m \times n}$ 两个矩阵对应位置的元素相乘并相加，可以理解为向量的点积在矩阵上的推广，即：

$$\begin{align} tr(\pmb{A}\pmb{B}^T)  &= a_{11}b_{11}+a_{12}b_{12}+\cdots+a_{1n}b_{1n}\\ &  +a_{21}b_{21}+a_{22}b_{22}+ \cdots +a_{2n}b_{2n}\\ & + \cdots \\ & + a_{m1}b_{m1} + a_{m2}b_{m2} + \cdots a_{mn}b_{mn} \end{align} \\\\ \tag{6}$$

**证明**

$$
\begin{align}  tr(\pmb{A}\pmb{B}^T) &= tr( \begin{bmatrix} a_{11} & a_{12} & \cdots & a_{1n} \\ a_{21} & a_{22} & \cdots & a_{2n} \\ \vdots & \vdots & \vdots & \vdots \\ a_{m1} & a_{m2} & \cdots & a_{mn} \\ \end{bmatrix} \begin{bmatrix} b_{11} & b_{21} & \cdots & b_{m1} \\ b_{12} & b_{22} & \cdots & b_{m2} \\ \vdots & \vdots & \vdots & \vdots \\ b_{1n} & b_{2n} & \cdots & b_{mn} \\ \end{bmatrix} )   \\\\   &=  tr \begin{bmatrix} a_{11}b_{11} + a_{12}b_{12} + \cdots + a_{1n}b_{1n} & 不用管 & \cdots & 不用管 \\ 不用管 & a_{21}b_{21} + a_{22}b_{22} + \cdots + a_{2n}b_{2n} & \cdots & 不用管 \\ \vdots & \vdots & \ddots & \vdots \\ 不用管 & 不用管 & \cdots & a_{m1}b_{m1} + a_{m2}b_{m2} + \cdots + a_{mn}b_{mn} \\ \end{bmatrix}_{m \times m} \\\\ &= a_{11}b_{11} + a_{12}b_{12} + \cdots + a_{1n}b_{1n}\\ & + a_{21}b_{21} + a_{22}b_{22} + \cdots + a_{2n}b_{2n}\\ & +  \cdots \\ & +  a_{m1}b_{m1} + a_{m2}b_{m2} + \cdots + a_{mn}b_{mn} \end{align} \\\\ \tag{7}
$$

**证毕。**

#### 2.5 交换律

矩阵乘积位置互换，迹不变

$$tr(AB)=tr(BA)\\\\ \tag{8}$$

其中, $A_{m \times n}, B_{n \times m}$。

**证明：**

把 $B_{n \times m}$ 看做是 $(B^T)_{m \times n}$ 的转置。由乘积的迹的本质，即 $(6)$ 式可知，无论乘积怎么交换顺序， $A_{m \times n}$ 与 $(B^T)_{m \times n}$ 对应位置的元素相乘并相加，永远是不变的。

**证毕。**

#### 2.6 更多的交换律

$$tr(ABC)=tr(CAB)=tr(BCA)\\\\ \tag{9}$$

其中, $A_{m \times n}, B_{n \times p}, C_{p \times m}$ 。

**证明：**

把两个矩阵的乘积看做一个矩阵，和另外的一个矩阵应用交换律即可。

**证毕。**

#### 2.7 熟练使用

$$tr(AB^T)=tr(B^TA)=tr(A^TB)=tr(BA^T)\\\\ \tag{10}$$

其中, $A_{m \times n}, B_{n \times m}$ 。

**证明：**

第一个和第二个是交换律，第二个和三个是转置，第三个和第四个是交换律。

**证毕。**

## 二. 微分与全微分
我们先来复习一下本科阶段所学的高等数学中的微分与全微分。
### 1、一元函数的微分
#### 1.1 普通函数的微分

设 $y=f(x)$ , $y$ 可导, 则其微分为：

$$\mathbb{d}y=\mathbb{d}f(x)=f'(x)\mathbb{d}x\\\\ \tag{11}$$

#### 1.2 复合函数的微分

设 $y=f(u), u=g(x)$ , 均可导, 则 $y$ 微分为：

$$\mathbb{d}y=\mathbb{d}f(u)=f'(u)\mathbb{d}g(x)=f'(u)g'(x)\mathbb{d}x\\\\ \tag{12}$$

乍一看很复杂，其实举个例子就很简单：

设 $y=sin(2x+1), u=2x+1$ , 则 $y$ 的微分为：

$$\begin{align} \mathbb{d}y&=\mathbb{d}(\sin{u})=\cos{u}\mathbb{d}u=\cos(2x+1)\mathbb{d}(2x+1) \\\\ &=\cos(2x+1) \cdot 2 \mathbb{d}x=2\cos(2x+1) \mathbb{d}x \end{align} \\\\ \tag{13}$$

### 2、多元函数的全微分
#### 2.1 普通函数的全微分

设 $z=f(x,y), z$ 可微, 则其全微分为：

$$\mathbb{d}z=\frac{\partial z}{\partial x}\mathbb{d}x+\frac{\partial z}{\partial y}\mathbb{d}y\\\\ \tag{14}$$

#### 2.2 复合函数的全微分

设 $z=f(u), u=\varphi(x,y), z$ 可导, $u$可微, 则其全微分为：

$$
\begin{align}
dz & = df(u)-f'(u)du=f'(u)(\frac{\partial u}{\partial x}dx+\frac{\partial u}{\partial y}dy)\\
&=f'(u)\frac{\partial u}{\partial x}dx+f'(u)\frac{\partial u}{\partial y}dy
\end{align}\\\ \tag{15}
$$

举个例子：
设 $z=sin(2x+y^2), u=2x+y^2$, 则 $z$ 的全微分为：

$$
\begin{align}
dz & = d(sin(u)) = cosudu=cos(2x+y^2)d(2x+y^2)\\
& = cos(2x+y^2)(2dx+2ydy)\\
& = 2cos(2x+y^2)dx+2ycos(2x+y^2)dy\\\
\end{align}
$$

### 3、微分/全微分的法则
#### 3.1 常数的微分

$$dc=0\\\\ \tag{16.1}$$

其中,  $c$ 为常数。

#### 3.2 线性法则
相加再微分等于微分再相加，常数提外面

$$d(c_1u+c_2v)=c_1du+c_2dv\\\\ \tag{16.2}$$

其中, 一元函数 $u=u(x), v=v(x)$ 或多元函数 $u=u(x,y, v=v(x,y), c_1,c_2$ 为常数。

#### 3.3 乘法法则
前微后不微 + 前不微后微

$$d(uv)=d(u)v+ud(v)\\ \tag{16.3}$$

#### 3.4 商法则
(上微下不微 减 上不微下微）**除以**（下的平方）

$$d(\frac{u}{v})=\frac{1}{v^2}(d(u)v-ud(v))$$

其中, 一元函数 $v=v(x)\neq0, u=u(x)$ 或多元函数 $v=v(x,y)\neq0, u=u(x,y)$ 。

## 三. 矩阵的微分
### 1、向量变元的实值标量函数


$$f(\pmb{x}),\pmb{x}=[x_1,x_2,\cdots,x_n]^T\\\\$$

他其实就是多元函数, 设其可微, 则他的全微分, 即 $(14)$ 式：

$$
\begin{align} df(\pmb{x}) &=\frac{\partial f}{\partial x_1}dx_1+\frac{\partial f}{\partial x_2}dx_2 + \cdots+\frac{\partial f}{\partial x_n}dx_n\\\\  &= (\frac{\partial f}{\partial x_1},\frac{\partial f}{\partial x_2},\cdots,\frac{\partial f}{\partial x_n})  \begin{bmatrix} dx_1 \\ dx_2\\ \vdots \\ dx_n \end{bmatrix}  \end{align}  \\\ \tag{17}
$$

结果是标量, 由 $(2)$ 式可知, $(17)$式可写成迹的形式, 即:

$$
\begin{align} df(\pmb{x})  &= (\frac{\partial f}{\partial x_1},\frac{\partial f}{\partial x_2},\cdots,\frac{\partial f}{\partial x_n})  \begin{bmatrix} dx_1 \\ dx_2\\ \vdots \\ dx_n \end{bmatrix} \\\\  &=\mathbb{tr}\Big((\frac{\partial f}{\partial x_1},\frac{\partial f}{\partial x_2},\cdots,\frac{\partial f}{\partial x_n})  \begin{bmatrix} dx_1 \\ dx_2\\ \vdots \\ dx_n \end{bmatrix}\Big)  \end{align}  \\\ \tag{18}
$$

### 2、矩阵变元的实值标量函数

$$
f(X), X_{m \times n}=(x_{ij})_{i=1,j=1}^{m,n}
$$

它也是多元函数，设其可微，则它的全微分，仍是 $(14)$ 式: 

$$\begin{align} df(\pmb{X}) &=\frac{\partial f}{\partial x_{11}}dx_{11}+\frac{\partial f}{\partial x_{12}}dx_{12} + \cdots+\frac{\partial f}{\partial x_{1n}}dx_{1n}\\ &+\frac{\partial f}{\partial x_{21}}dx_{21}+\frac{\partial f}{\partial x_{22}}dx_{22} + \cdots+\frac{\partial f}{\partial x_{2n}}dx_{2n}\\ &+\cdots\\ &+\frac{\partial f}{\partial x_{m1}}dx_{m1}+\frac{\partial f}{\partial x_{m2}}dx_{m2} + \cdots+\frac{\partial f}{\partial x_{mn}}dx_{mn}  \end{align}  \\\ \tag{19}$$

我们从这个结果中发现，它其实就是矩阵 $(\frac{\partial f}{\partial x_{ij}})_{i=1,\ j=1}^{m,\ n}$ 与矩阵 $(dx_{ij})_{i=1,j=1}^{m,n}$ 对应位置的元素相乘并相加，由 $(6)$ 式可知， $(19)$ 式也可以写成迹的形式，即：

$$\begin{align} df(\pmb{X}) &=\frac{\partial f}{\partial x_{11}}dx_{11}+\frac{\partial f}{\partial x_{12}}dx_{12} + \cdots+\frac{\partial f}{\partial x_{1n}}dx_{1n}\\ &+\frac{\partial f}{\partial x_{21}}dx_{21}+\frac{\partial f}{\partial x_{22}}dx_{22} + \cdots+\frac{\partial f}{\partial x_{2n}}dx_{2n}\\ &+\cdots\\ &+\frac{\partial f}{\partial x_{m1}}dx_{m1}+\frac{\partial f}{\partial x_{m2}}dx_{m2} + \cdots+\frac{\partial f}{\partial x_{mn}}dx_{mn}  \\\\  &=tr( \begin{bmatrix} \frac{\partial f}{\partial x_{11}}&\frac{\partial f}{\partial x_{21}}&\cdots&\frac{\partial f}{\partial x_{m1}} \\ \frac{\partial f}{\partial x_{12}}&\frac{\partial f}{\partial x_{22}}& \cdots & \frac{\partial f}{\partial x_{m2}}\\ \vdots&\vdots&\vdots&\vdots\\ \frac{\partial f} {\partial x_{1n}}&\frac{\partial f}{\partial x_{2n}}&\cdots&\frac{\partial f}{\partial  x_{mn}}  \end{bmatrix}_{n\times m} \begin{bmatrix} dx_{11}  & dx_{12} & \cdots  & dx_{1n} \\ dx_{21}  & dx_{22} & \cdots  & dx_{2n} \\ \vdots&\vdots&\vdots&\vdots\\ dx_{m1}  & dx_{m2} & \cdots  & dx_{mn}  \end{bmatrix}_{m \times n} ) \end{align}  \\\ \tag{20}$$

### 3、矩阵变元的实矩阵函数

$$
F(X), F_{p \times q}=(f_{ij})_{i=1, j=1}^{p,q}, X_{m \times n}=(x_{ij})_{i=1,j=1}^{m,n}
$$

矩阵变元的实矩阵函数，它的每个元素其实就是一个矩阵变元的实值标量函数 $f_{i,j}(X)$ 。

我们定义：设  $f_{i,j}(X)$ 可微, 则矩阵变元的实矩阵函数的矩阵微分，就是对应每个位置的元素 $f_{i,j}(X)$ 求全微分，排列布局**不变**, 即：

$$
\begin{align} d\pmb{F}_{p \times q}(\pmb{X}) & = \begin{bmatrix} df_{11}(\pmb{X})& df_{12}(\pmb{X}) & \cdots & df_{1q}(\pmb{X}) \\ df_{21}(\pmb{X})& df_{22}(\pmb{X}) & \cdots & df_{2q}(\pmb{X}) \\ \vdots&\vdots&\vdots&\vdots \\ df_{p1}(\pmb{X})& df_{p2}(\pmb{X}) & \cdots & df_{pq}(\pmb{X})  \end{bmatrix}_{p \times q}  \end{align}  \\\ \tag{21}
$$

#### 3.1 四个法则
##### a. 常数矩阵的矩阵微分

$$
dA_{m \times n}=0_{m \times n}\\\ \tag{22.1}
$$

**证明:**

$A$的每个元素都是常数, 由 $(16.1)$ 得, 每个元素的微分都是 0。

**证毕。**

##### b. 线性法则
相加再微分等于微分再相加, 常数提外面

$$
d \big(c_1F(X)+c_2G(X)\big)=c_1dF(x)+c_2dG(x)\\\ \tag{22.2}
$$

其中, $c_1,c_2$ 是常数。

**证明:**

$c_1F(X)+c_2G(X)$ 的每个元素都是 $c_1f_{ij}(X)+c_2g_{ij}(X)$, 由 $(16.2)$ 式可知, 每个元素的全微分是 $c_1df_{ij}(X)+c_2dg_{ij}(X)$ 。

**证毕。**

##### c. 乘积法则
前微后不微 + 前不微后微

$$
d \big(F(X)G(X) \big)=d\big(F(X)\big)G(X)+F(X)dG(X)\\\ \tag{22.3.1}
$$

其中, $F_{p \times q}(X),\ G_{p \times q}(X)$ 。

**注意：** 此时的微分是矩阵, **不能**交换乘机的左右顺序。

**证明：**

$F(X)G(X)$ 的每个元素都是   , 由 $(16.2)$ 式、 $(16.3)$ 式可知, 每个元素的全微分是

$$
\begin{align}
d\left( \sum_{k=1}^q[f_{ik}(\pmb{X})g_{kj}(\pmb{X})] \right) & =\sum_{k=1}^q d(f_{ik}(\pmb{X})g_{kj}(\pmb{X})) \\\\
& = \sum_{k=1}^q[d(f_{ik}(\pmb{X}))g_{kj}(\pmb{X})+f_{ik}(\pmb{X})dg_{kj}(\pmb{X})] \\\\ 
& = \sum_{k=1}^q[d(f_{ik}(\pmb{X}))g_{kj}(\pmb{X})]+ \sum_{k=1}^q[f_{ik}(\pmb{X})dg_{kj}(\pmb{X})]   
\end{align}  \\\ \tag{22.3.1a}
$$

结果左边的求和式，就是 $d\big(F(X)\big)G(X)$ 的每个元素，结果右边的求和式，就是 $F(X)dG(X)$ 的每个元素。

**证毕。**

由此，很容易得到更多个乘积的法则：

$$
\mathbb{d}(\pmb{F}(\pmb{X})\pmb{G}(\pmb{X})\pmb{H}(\pmb{X}))=\mathbb{d}(\pmb{F}(\pmb{X}))\pmb{G}(\pmb{X})\pmb{H}(\pmb{X}) + \pmb{F}(\pmb{X})\mathbb{d}(\pmb{G}(\pmb{X}))\pmb{H}(\pmb{X})+ \pmb{F}(\pmb{X})\pmb{G}(\pmb{X})\mathbb{d}\pmb{H}(\pmb{X}) \\\\ \tag{22.3.2}
$$

**证明：**

$$
\begin{align} \mathbb{d}(\pmb{F}(\pmb{X})\pmb{G}(\pmb{X})\pmb{H}(\pmb{X}))  &= \mathbb{d}(\pmb{F}(\pmb{X}))\pmb{G}(\pmb{X})\pmb{H}(\pmb{X})+\pmb{F}(\pmb{X})\mathbb{d}(\pmb{G}(\pmb{X})\pmb{H}(\pmb{X}))  \\\\  &=  \mathbb{d}(\pmb{F}(\pmb{X}))\pmb{G}(\pmb{X})\pmb{H}(\pmb{X}) +\pmb{F}(\pmb{X})[\mathbb{d}(\pmb{G}(\pmb{X}))\pmb{H}(\pmb{X}) + \pmb{G}(\pmb{X})\mathbb{d}\pmb{H}(\pmb{X})]   \\\\  &=\mathbb{d}(\pmb{F}(\pmb{X}))\pmb{G}(\pmb{X})\pmb{H}(\pmb{X}) + \pmb{F}(\pmb{X})\mathbb{d}(\pmb{G}(\pmb{X}))\pmb{H}(\pmb{X})+ \pmb{F}(\pmb{X})\pmb{G}(\pmb{X})\mathbb{d}\pmb{H}(\pmb{X})  \end{align} \\\\ \tag{22.3.2a}
$$

##### d. 转置法则

转置的矩阵微分等于矩阵微分的转置

$$
\mathbb{d}\pmb{F}_{p \times q}^T(\pmb{X})=(\mathbb{d}\pmb{F}_{p \times q})^T\\\ \tag{22.4.1}
$$

**证明：**

$$
\begin{align} \mathbb{d}\pmb{F}^T_{p \times q}(\pmb{X})  &= \mathbb{d} \begin{bmatrix}  f_{11}(\pmb{X})& f_{21}(\pmb{X}) & \cdots & f_{p1}(\pmb{X}) \\ f_{12}(\pmb{X})& f_{22}(\pmb{X}) & \cdots & f_{p2}(\pmb{X}) \\  \vdots&\vdots&\vdots&\vdots \\  f_{1q}(\pmb{X})&f_{2q}(\pmb{X}) & \cdots & f_{pq}(\pmb{X})   \end{bmatrix}_{q \times p}   \\\\ &= \begin{bmatrix}  \mathbb{d}f_{11}(\pmb{X})& \mathbb{d}f_{21}(\pmb{X}) & \cdots & \mathbb{d}f_{p1}(\pmb{X}) \\ \mathbb{d}f_{12}(\pmb{X})& \mathbb{d}f_{22}(\pmb{X}) & \cdots & \mathbb{d}f_{p2}(\pmb{X}) \\  \vdots&\vdots&\vdots&\vdots \\  \mathbb{d}f_{1q}(\pmb{X})&\mathbb{d}f_{2q}(\pmb{X}) & \cdots & \mathbb{d}f_{pq}(\pmb{X})   \end{bmatrix}_{q \times p}   \\\\  &= \begin{bmatrix} \mathbb{d}f_{11}(\pmb{X})& \mathbb{d}f_{12}(\pmb{X}) & \cdots & \mathbb{d}f_{1q}(\pmb{X}) \\ \mathbb{d}f_{21}(\pmb{X})& \mathbb{d}f_{22}(\pmb{X}) & \cdots & \mathbb{d}f_{2q}(\pmb{X}) \\ \vdots&\vdots&\vdots&\vdots \\ \mathbb{d}f_{p1}(\pmb{X})& \mathbb{d}f_{p2}(\pmb{X}) & \cdots & \mathbb{d}f_{pq}(\pmb{X})  \end{bmatrix}_{p \times q}^T \\\\ &=  (\mathbb{d}\pmb{F}_{p \times q}(\pmb{X}))^T \end{align}  \\\ \tag{22.4.2}
$$

**证毕。**

#### 3.2 为什么要使用矩阵微分求导

$\pmb{X}_{m \times n}$ 自己就是矩阵变元 $\pmb{X}_{m \times n}$ 的实矩阵函数，他的每个元素是 $x_{ij}$, 每个元素的全微分是 $\pmb{d}x_{ij}$ 。

因此, $\pmb{X}_{m \times n}$的矩阵微分是:

$$
\begin{align}
\mathbb{d}\pmb{X}_{m \times n} &=  \begin{bmatrix} \mathbb{d}x_{11}& \mathbb{d}x_{12} & \cdots & \mathbb{d}x_{1n} \\  \mathbb{d}x_{21}& \mathbb{d}x_{22} & \cdots & \mathbb{d}x_{2n} \\  \vdots&\vdots&\vdots&\vdots \\  \mathbb{d}x_{m1}& \mathbb{d}x_{m2} & \cdots & \mathbb{d}x_{mn} \\  \end{bmatrix}_{m \times n}  
\end{align}  \\\ \tag{23.1}
$$

向量 $\pmb{x}=[x_1,x_2,\cdots,x_n]^T$的矩阵微分是:

$$
\begin{align} \mathbb{d}\pmb{x} &=   \begin{bmatrix}  \mathbb{d}x_{1}\\   \mathbb{d}x_{2}\\   \vdots \\  \mathbb{d}x_{n} \\   \end{bmatrix}_{n \times 1}   \end{align}  \\\ \tag{23.2}
$$

于是，我们刚刚讲到的矩阵微分四个法则，对于 $\pmb{dX}_{m \times n},\pmb{dx}$ 也是适用的。

我们现在回到矩阵变元的实值标量函数的全微分，即 $(20)$ 式：

$$\begin{align} df(\pmb{X}) &=\frac{\partial f}{\partial x_{11}}dx_{11}+\frac{\partial f}{\partial x_{12}}dx_{12} + \cdots+\frac{\partial f}{\partial x_{1n}}dx_{1n}\\ &+\frac{\partial f}{\partial x_{21}}dx_{21}+\frac{\partial f}{\partial x_{22}}dx_{22} + \cdots+\frac{\partial f}{\partial x_{2n}}dx_{2n}\\ &+\cdots\\ &+\frac{\partial f}{\partial x_{m1}}dx_{m1}+\frac{\partial f}{\partial x_{m2}}dx_{m2} + \cdots+\frac{\partial f}{\partial x_{mn}}dx_{mn}  \\\\  &=tr( \begin{bmatrix} \frac{\partial f}{\partial x_{11}}&\frac{\partial f}{\partial x_{21}}&\cdots&\frac{\partial f}{\partial x_{m1}} \\ \frac{\partial f}{\partial x_{12}}&\frac{\partial f}{\partial x_{22}}& \cdots & \frac{\partial f}{\partial x_{m2}}\\ \vdots&\vdots&\vdots&\vdots\\ \frac{\partial f} {\partial x_{1n}}&\frac{\partial f}{\partial x_{2n}}&\cdots&\frac{\partial f}{\partial  x_{mn}}  \end{bmatrix}_{n\times m} \begin{bmatrix} dx_{11}  & dx_{12} & \cdots  & dx_{1n} \\ dx_{21}  & dx_{22} & \cdots  & dx_{2n} \\ \vdots&\vdots&\vdots&\vdots\\ dx_{m1}  & dx_{m2} & \cdots  & dx_{mn}  \end{bmatrix}_{m \times n} ) \end{align}  \\\ \tag{20}$$

观察 $(20)$ 式的结果, 发现在 $tr$ 中, 左边的矩阵其实就是上一篇 (本质篇_9) 式: 

$$
\begin{align} \text{D}_{\pmb{X}}f(\pmb{X})&= \frac{\partial f(\pmb{X})}{\partial \pmb{X}^T_{m\times n}} \\\\ &= \begin{bmatrix} \frac{\partial f}{\partial x_{11}}&\frac{\partial f}{\partial x_{21}}&\cdots&\frac{\partial f}{\partial x_{m1}} \\ \frac{\partial f}{\partial x_{12}}&\frac{\partial f}{\partial x_{22}}& \cdots & \frac{\partial f}{\partial x_{m2}}\\ \vdots&\vdots&\vdots&\vdots\\ \frac{\partial f} {\partial x_{1n}}&\frac{\partial f}{\partial x_{2n}}&\cdots&\frac{\partial f}{\partial  x_{mn}}  \end{bmatrix}_{n\times m} \end{align} \\\\
\tag{本质篇_9}
$$

而右边的矩阵，其实就是 $(23.1)$ 式: 

$$
\begin{align}
\mathbb{d}\pmb{X}_{m \times n} &=  \begin{bmatrix} \mathbb{d}x_{11}& \mathbb{d}x_{12} & \cdots & \mathbb{d}x_{1n} \\  \mathbb{d}x_{21}& \mathbb{d}x_{22} & \cdots & \mathbb{d}x_{2n} \\  \vdots&\vdots&\vdots&\vdots \\  \mathbb{d}x_{m1}& \mathbb{d}x_{m2} & \cdots & \mathbb{d}x_{mn} \\  \end{bmatrix}_{m \times n}  
\end{align}  \\\ \tag{23.1}
$$

因此, 矩阵变元的实值标量函数的全微分，即 $(20)$ 式，可以写成：

$$
\pmb{d}f(\pmb{X})= \operatorname{tr}(\frac{\partial f(\pmb{X})}{\partial \pmb{X}^T}\pmb{dX})\\\\ \tag{24}
$$

别忘了我们的目标是什么，其实就是要求 $\frac{\partial f(\pmb{X})}{\partial \pmb{X}^T}$ 。所以，只要我们可以把一个矩阵变元的实值标量函数的全微分写成 $(24)$ 式，我们就找到了矩阵求导的结果。（已经有人证明，这样的结果是唯一的。即若 $\pmb{d}f(\pmb{X})=\pmb{tr}(A_1\pmb{dX})=\pmb{tr}(A_2\pmb{dX})$ ，则 $A_1=A_2$ )

对于向量变元的实值标量函数的全微分，即 $(18)$ 式，同样可以写成：

$$
\mathbb{d}f (\pmb{x}) = \operatorname{tr}(\frac{\partial f (\pmb{x})}{\partial \pmb {x}^T} \mathbb{d}\pmb{x})\\\\
\tag{25}
$$

当矩阵变元 $X$ 本身就是一个列向量时 $\pmb{x}$ 时

$$
\frac{\partial f(\pmb{X})}{\partial \pmb{X}^T}= \frac{\partial f (\pmb{x})}{\partial \pmb {x}^T}
$$

同时，由 $(23.1)$ 式、 $(23.2)$ 式，当矩阵 $\pmb X $ 本身是列向量 、$\pmb x$ 时，也有

$$
\mathbb{d} \pmb X = \mathbb{d} \pmb x \\\\
\tag{27}
$$

所以，矩阵变元或向量变元的实值标量函数的矩阵求导的结果，都可以通过 $(24)$ 式得到：

$$
\pmb{d}f(\pmb{X})= \operatorname{tr}(\frac{\partial f(\pmb{X})}{\partial \pmb{X}^T}\pmb{dX})\\\\ \tag{24}
$$

那么，我们该如何写成形如 $(24)$ 式的结果呢，别急，让我们先给出 $3\times 2=6$ 个你应该记住的公式（以后就直接用了）。

##### 3.2.1 夹层饼

$$
\mathbb{d} (\pmb {AXB})=\pmb A \mathbb{d}(\pmb X)\pmb B \\\\
\tag{25.1.1}
$$

其中, $\pmb {A}_{p \times m},\ \pmb B_{n \times q}$ 是常数矩阵。

**证明:**

由乘积法则 $(22.3.2)$ 式得:

$$
\mathbb{d}(\pmb {AXB})=\mathbb{d}(\pmb A)\pmb {XB}+\pmb A \mathbb{d}(\pmb X)\pmb B+\pmb {AX}\mathbb{d}\pmb B\\\\
\tag{25.1.a}
$$

由常数矩阵微分 $(22.1)$ 式得:

$$
\mathbb{d} \pmb A = \pmb 0_{p \times m}, \mathbb{d} \pmb B =\pmb 0_{n \times q}\\\\
\tag{25.1.b}
$$

**证毕。**

$\pmb X_{m\times n}$ 可以代入其他任意的矩阵函数:

$$
\mathbb{d}\big( \pmb{AF}(\pmb X)\pmb B \big)=\pmb A \mathbb{d}\big( \pmb F(\pmb X) \big)\pmb B\\\\
\tag{25.1.2}
$$

##### 3.2.2 行列式

$$
\mathbb{d} |\pmb X| = |\pmb X|\operatorname{tr}(\pmb X^{-1}\mathbb{d}\pmb X) = \operatorname{tr}(|\pmb X|\pmb X^{-1}\mathbb{d}\pmb X)\\\\
\tag{25.2.1}
$$

其中, $\pmb X_{n \times n}$ 。

**证明:**

首先明确, 行列式是一个实值标量函数, 故可以使用 $(24)$ 式。

我们知道, 行列式可以按照一行展开, 即一行中每个元素乘以他的**代数余子式**然后求和。

我们按照元素 $x_{ij}$ 所在的第 $i$ 行展开:

$$
|\pmb X|=x_{i1}A_{i1}+x_{i2}A_{i2}+\cdots +x_{in}A_{in}\\\\
\tag{25.2.a}
$$

因此，行列式对元素 $x_{ij}$ 的偏导，即为该元素对应的代数余子式。

$$
\frac{\partial |\pmb X|}{\partial x_{ij}}=A_{ij}\\\\
\tag{25.2.b}
$$

因此, 行列式对矩阵求导的结果为:

$$
\begin{align} \frac{\partial |\pmb{X}|}{\partial \pmb{X}^T} &=  \begin{bmatrix} A_{11} & A_{21} & \cdots & A_{n1} \\ A_{12} & A_{22} & \cdots & A_{n2} \\ \vdots & \vdots & \ddots & \vdots \\ A_{1n} & A_{2n} & \cdots & A_{nn} \\ \end{bmatrix}  \end{align} \\\\ \tag{25.2.c}
$$

这个结果其实就是伴随矩阵 $\pmb X^*$。

又因为伴随矩阵和逆矩阵的关系: 

$$
\pmb X^{-1} = \frac{\pmb X^*}{|\pmb X|}\\\\
\tag{25.2.d}
$$

代入 $(24)$:

$$
\begin{aligned}
\mathbb{d} |\pmb X| & = \operatorname{tr}(\frac{\partial |\pmb X|}{\partial \pmb X^T})\\\\
 & = \operatorname{tr}(|\pmb X|\pmb X^{-1}\mathbb{d}\pmb X)
\end{aligned}
$$

又因为行列式是标量，由 $(3)$ 式，可以提到迹的外面，得:

$$
\mathbb{d} |\pmb X| = |\pmb X| \operatorname{tr}(\pmb X^{-1}\mathbb{d}\pmb X) = \operatorname{tr}(|\pmb X|\pmb X^{-1}\mathbb{d}\pmb X)\\\\
\tag{25.2.1}
$$

**证毕。**

$\pmb X_{n\times n}$ 可以代入其他任意的矩阵函数:

$$
\mathbb{d} |\pmb F (\pmb X)| = |\pmb F (\pmb X)| \operatorname{tr}(\pmb F (\pmb X)^{-1}\mathbb{d}\pmb F (\pmb X)) = \operatorname{tr}(|\pmb F (\pmb X)|\pmb F (\pmb X)^{-1}\mathbb{d}\pmb F (\pmb X))\\\\
\tag{25.2.2}
$$

#### 3.3 如何使用矩阵微分求导

对于实值标量函数 $f (\pmb{X})$, $\operatorname{tr}\big( f(\pmb X) \big)=f(\pmb X)$ , $\mathbb{d}f(\pmb X)=\operatorname{tr}\big( \mathbb{d}f(\pmb X) \big)$

所以有

$\mathbb{d}f(\pmb X)=\mathbb{d}\big(\operatorname{tr}f(\pmb X)\big)=\operatorname{tr}\big( \mathbb{d}f(\pmb X) \big)$

