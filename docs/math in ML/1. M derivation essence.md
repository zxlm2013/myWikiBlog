!!! info ""

    参考链接:
    
    [矩阵求导的本质与分子布局、分母布局的本质（矩阵求导——本质篇）](https://zhuanlan.zhihu.com/p/263777564)

## 一. 函数与标量、向量、矩阵
考虑一个函数

$$
\text{function(input)}
$$

针对 $\text function$ 的类型、$\text input$的类型, 我们可以将这个函数 $\text function$ 分为不同的种类。

### 1、function 是一个标量

我们称 $\text function$ 是以一个**实值标量的函数**。用细体小写字母 $f$ 表示。

#### 1.1 input 是一个标量

我们称 $\text function$ 的**变元**是**标量**。用细体小写字母 $x$ 表示。

**例1:**

$$
f(x)=x+2\\\\ \tag{e.g.1}
$$

#### 1.2 input 是一个向量

我们称 $\text function$ 的**变元**是**向量**。用粗体小写字母 $\pmb{x}$ 表示。

**例2:** 设 $\pmb{x}=[x_1,x_2,x_3]^T$ 

$$
f(\pmb{x}) = a_1x_1^2+a_2x_2^2+a_3x_3^2+a_4x_1x_2\\\\ \tag{e.g.2}
$$

#### 1.3 input 是一个矩阵

我们称 $\text function$ 的**变元**是**矩阵**。用粗体大写字母 $\pmb{X}$ 表示。

**例3:** 设 $\pmb{X}_{3 \times 2}=(x_{ij})_{i=1,j=1}^{3,2}$ 

$$
f(\pmb{X})=a_1x_{11}^2+a_2x_{12}^2+a_3x_{21}^2+a_4x_{22}^2+a_5x_{31}^2+a_6x_{32}^2\\\\ \tag{e.g.3}
$$

### 2、function 是一个向量

我们称 $\text function$ 是一个**实向量函数**。用**粗体**小写字母 $\pmb{f}$ 表示。

**含义:** $\pmb{f}$ 是由若干个 $f$ 组成的**向量**。

同样地, 变元分为三种: **标量、向量、矩阵**。这里的符号仍和上面的相同。

#### 2.1 标量变元

**例四:**

$$
\pmb{f}_{3 \times 1}(x)= 
\begin{bmatrix}
f_1(x) \\\\
f_2(x) \\\\
f_3(x) 
\end{bmatrix}=
\begin{bmatrix}
x+1 \\\\
2x+1 \\\\
3x^2+1 
\end{bmatrix}
\\\\ \tag{e.g.4}
$$

#### 2.2 向量变元

**例5:** 设 $\pmb{x}=[x_1,x_2,x_3]^T$

$$
f_{3 \times 1}(\pmb{x})=
\begin{bmatrix}
f_1(\pmb{x})\\\\
f_2(\pmb{x})\\\\
f_3(\pmb{x})
\end{bmatrix}=
\begin{bmatrix}
x_1+x_2+x_3\\\\
x_1^2+2x_2+2x_3\\\\
x_1x_2+x_2+x_3
\end{bmatrix}\\\\ \tag{e.g.5}
$$

#### 2.3 矩阵变元

**例6：** 设 $\pmb{X}_{3 \times 2}=(x_{ij})_{i=1,j=1}^{3,2}$

$$
\pmb{f}_{3\times1}(\pmb{X})=
\begin{bmatrix}
f_1(\pmb{X})\\\\
f_2(\pmb{X})\\\\
f_3(\pmb{X})
\end{bmatrix} 
= \begin{bmatrix} 
x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32}\\\\
x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32}+x_{11}x_{12}\\\\ 2x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32}+x_{11}x_{12}
\end{bmatrix} \\\\ \tag{e.g.6}
$$

### 3、function 是一个矩阵

我们称 $\text function$ 是一个**实矩阵函数**。用**粗体**大写字母 $\pmb{F}$ 表示。

**含义:**  $\pmb{F}$ 是由若干个 $f$ 组成的一个**矩阵**。

同样地, 变元分三中: **标量、向量、矩阵**。这里的符号仍与上面的相同。

#### 3.1 标量变元

**例7:**

$$
\pmb{F}_{3 \times 2}(x)=
\begin{bmatrix}
f_{11}(x) & f_{12}(x)\\\\
f_{21}(x) & f_{22}(x)\\\\
f_{31}(x) & f_{32}(x)
\end{bmatrix}=
\begin{bmatrix}
x+1 & 2x+2\\\\
x^2+1 & 2x^2+1\\\\
x^3+1 & 2x^3+1
\end{bmatrix}\\\\ \tag{e.g.7}
$$

#### 3.2 向量变元

**例8:** 设 $\pmb{x}=[x_1,x_2,x_3]^T$

$$
\pmb{F}_{3\times2}(\pmb{x})= \left[ \matrix{ f_{11}(\pmb{x}) & f_{12}(\pmb{x})\\ f_{21}(\pmb{x}) & f_{22}(\pmb{x})\\ f_{31}(\pmb{x}) & f_{32}(\pmb{x})\\ } \right] = \left[  \matrix{ 2x_{1}+x_{2}+x_{3} & 2x_{1}+2x_{2}+x_{3} \\ 2x_{1}+2x_{2}+x_{3} & x_{1}+2x_{2}+x_{3} & \\ 2x_{1}+x_{2}+2x_{3} & x_{1}+2x_{2}+2x_{3} & } \right] \\\\ \tag{e.g.8}
$$

#### 3.3 矩阵变元

**例9：** 设 $\pmb{X}_{3 \times 2}=(x_{ij})_{i=1,j=1}^{3,2}$

$$
\begin{align*} \pmb{F}_{3\times2}(\pmb{X})&= \left[ \matrix{ f_{11}(\pmb{X}) & f_{12}(\pmb{X})\\ f_{21}(\pmb{X}) & f_{22}(\pmb{X})\\ f_{31}(\pmb{X}) & f_{32}(\pmb{X})\\ } \right]\\\\ &= \left[  \matrix{ x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32} & 2x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32}\\ 3x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32} & 4x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32}\\ 5x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32} & 6x_{11}+x_{12}+x_{21}+x_{22}+x_{31}+x_{32} } \right] \end{align*} \\\\ \tag{e.g.9}
$$

### 4、总结

| $funtion/input$ | 标量变元 | 向量变元 | 矩阵变元 |
| ------------- | -------- | -------- | -------- |
| 实值标量函数  | $f(x)$     | $f(\pmb{x})$     | $f(\pmb{X})$     |
| 实向量函数    | $\pmb{f}(x)$     | $\pmb{f(x)}$     | $\pmb{f(X)}$     |
| 实矩阵函数    | $\pmb{F}(x)$     | $\pmb{F(x)}$     | $\pmb{F(X)}$     |

## 二. 矩阵求导的本质

我们在高等数学中学过, 对于一个多元函数

**例10:**

$$
f(x_1,x_2,x_3)=x_1^2+x_1x_2+x_2x_3\\\\ \tag{e.g.10}
$$

我们可以将 $\pmb{f}$ 对 $x_1,x_2,x_3$的**偏导**分别求出来, **即:**

$$
\left\{ \begin{align*} \frac{\partial f}{\partial x_1} & = 2x_1+x_2 \\\\ \frac{\partial f}{\partial x_2} & = x_1+x_3 \\\\ \frac{\partial f}{\partial x_3} & = x_2 \end{align*} \right. \\\\
$$

矩阵求导也是一样，**本质就是 $function$ 中的每个 $f$ 分别对变元中的每个元素逐个求偏导, 只不过写成了向量、矩阵形式而已。**

对于 $(e.g.10)$ , 我们把得出的三个结果写成列向量形式:


$$
\frac{\partial f(\pmb{x})}{\partial \pmb{x}_{3 \times 1}}=
\begin{bmatrix} \frac{\partial f}{\partial x_1}\\\\
\frac{\partial f}{\partial x_2}\\\\
\frac{\partial f}{\partial x_3}\\\end{bmatrix}=
\begin{bmatrix} 2x_1+x_2\\\\
x_1+x_3\\\\
x_2 \\\end{bmatrix}\\\\ \tag{1}
$$

一个矩阵求导**以列向量形式展开**的雏形就出现了。

当然我们也可以**以行向量形式展开:**

$$
\frac{\partial f(\pmb{x})}{\partial \pmb{x}_{3 \times 1}^T}=\Big[\frac{\partial f}{\partial x_1},\frac{\partial f}{\partial x_2}, \frac{\partial f}{\partial x_3}\Big]=[2x_1+x_2, x_1+x_3,x_2]\\\\ \tag{2}
$$

所以, 如果 $function$ 中有 $m$ 个 $f$ , 变元中有 $n$ 个元素, 那么每个 $f$ 对变元中的每个元素逐个求偏导后，我们就会产生 $m \times n$ 个结果。

**这就是矩阵求导的本质。**

至于这 $m \times n$个结果的布局, 是写成行向量, 还是列向量, 还是写成矩阵, 就是我们接下来要讨论的事情。

## 三. 矩阵求导结果的布局

**不严谨**地说，从**直观**上看: 

**分子布局**, 就是分子是**列向量**形式, 分母是**行向量**形式, 如 $(2)$ 式。如果这里的 $function$ 是实向量函数 $\pmb f_{21}$ 的话, 结果就是 $2 \times 3$ 的矩阵了：

$$
\frac{\partial \pmb{f}_{2 \times 1}(\pmb{x})}    {\partial \pmb{x}_{3 \times 1}^T}=
\begin{bmatrix} 
\frac{\partial f_1}{\partial x_1} & \frac{\partial f_1}{\partial x_2} & \frac{\partial f_1}{\partial x_3} \\\\
\frac{\partial f_2}{\partial x_1} & \frac{\partial f_2}{\partial x_2} & \frac{\partial f_2}{\partial x_3}
\\\end{bmatrix}_{2 \times 3}\\\\ \tag{3}
$$

**分母布局**, 就是分母是**列向量**形式, 分子是**行向量**形式, 如 $(1)$ 式。如果这里的 $function$ 是实向量函数 $\pmb f_{21}$ 的话, 结果就是 $3 \times 2$ 的矩阵了：

$$
\frac{\partial \pmb{f}_{2 \times 1}^T(\pmb{x})}    {\partial \pmb{x}_{3 \times 1}}=
\begin{bmatrix} 
\frac{\partial f_1}{\partial x_1} & \frac{\partial f_2}{\partial x_1} \\\\
\frac{\partial f_1}{\partial x_2} & \frac{\partial f_2}{\partial x_2} \\\\
\frac{\partial f_1}{\partial x_3} & \frac{\partial f_2}{\partial x_3}
\end{bmatrix}_{3 \times 2}\\\\ \tag{4}
$$

直观上理解了之后，我们针对不同类型的 $function$ ，不同类型的**变元**，给出**严谨**的布局说明。（这里不讨论标量变元的实值标量函数 $f(x)$ ，因为结果就是一个元素嘛~）

### 1、向量变元的实值函数

$$
f(\pmb{x}), \pmb{x}=[x_1,x_2,\cdots , x_n]^T
$$

#### 1.1 行向量偏导形式(行偏导向量)

$$
D_{\pmb{x}}f(\pmb{x})=\frac{\partial f(\pmb x)}{\partial \pmb{x}^T}=\Big[\frac{\partial f}{\partial x_1}, \frac{\partial f}{\partial x_2}, \cdots , \frac{\partial f}{\partial x_n}\Big]\\\\
\tag{5}
$$

#### 1.2 梯度向量形式(列向量偏导 列偏导向量)

$$
\nabla_{\pmb {x}}f(\pmb {x})=\frac{\partial f(\pmb{x})}{\partial \pmb{x}}=\Big[\frac{\partial f}{\partial x_1}, \frac{\partial f}{\partial x_2}, \cdots , \frac{\partial f}{\partial x_n}\Big]^T\\\\
\tag{6}
$$

这两种形式**互为转置**。

### 2、矩阵变元的实值标量函数

$$
f(\pmb {X}), \pmb {X}_{m \times n}=(x_{ij})_{i=1,j=1}^{m,n}
$$

先介绍一个符号 $\text{vec}(\pmb {X})$, 作用是将矩阵 $\pmb {X}$ 按列堆栈来向量化。

解释一下, $\text{vec}(\pmb {X})$ 就是把矩阵 $\pmb {X}$ 的第 1 列, 第 2 列, 直到第 n 列取出来，然后按顺序组成一个列向量，即：

$$
\text{vec}(\pmb {X})=[x_{11},x_{21},\cdots ,x_{m1},x_{12},x_{22},\cdots ,x_{m2},\cdots , x_{1n},x_{2n},\cdots ,x_{mn}]^T\\\\
\tag{7}
$$

#### 2.1 行向量偏导形式(行偏导向量)
即先把**矩阵变元** $\pmb {X}$ 按 $vec$ **向量化**，转换成**向量**变元，再对该**向量变元**使用 $(5)$ 式：

$$
\begin{align*} \text{D}_{\text{vec}\pmb{X}}f(\pmb{X})&= \frac{\partial f(\pmb{X})}{\partial \text{vec}^T(\pmb{X})} \\\\ &= \left[ \frac{\partial f}{\partial x_{11}},\frac{\partial f}{\partial x_{21}},\cdots,\frac{\partial f}{\partial x_{m1}},\frac{\partial f}{\partial x_{12}},\frac{\partial f}{\partial x_{22}},\cdots,\frac{\partial f}{\partial x_{m2}},\cdots,\frac{\partial f} {\partial x_{1n}},\frac{\partial f}{\partial x_{2n}},\cdots,\frac{\partial f}{\partial  x_{mn}} \right] \end{align*} \\\\  \tag{8}
$$

#### 2.2 Jacobian矩阵形式
即先把**矩阵变元** $\pmb {X}$ 进行转置, 再对转置后的每个位置的元素逐个求偏导，结果布局和转置布局一样。

$$
\begin{align*} \text{D}_{\pmb{X}}f(\pmb{X})&= \frac{\partial f(\pmb{X})}{\partial \pmb{X}^T_{m\times n}} \\\\ &= \left[  \matrix{ \frac{\partial f}{\partial x_{11}}&\frac{\partial f}{\partial x_{21}}&\cdots&\frac{\partial f}{\partial x_{m1}} \\ \frac{\partial f}{\partial x_{12}}&\frac{\partial f}{\partial x_{22}}& \cdots & \frac{\partial f}{\partial x_{m2}}\\ \vdots&\vdots&\vdots&\vdots\\ \frac{\partial f} {\partial x_{1n}}&\frac{\partial f}{\partial x_{2n}}&\cdots&\frac{\partial f}{\partial  x_{mn}} } \right]_{n\times m} \end{align*} \\\\  \tag{9}
$$

#### 2.3 梯度向量形式(列偏导向量, 列向量偏导)

即线把**矩阵**变元 $\pmb{X}$ 按 $\text{vec}$ **向量化**, 转换成**向量**变元, 再对该**变元**使用 $(6)$ 式:

$$
\begin{align*} \nabla_{\text{vec}\pmb{X}}f(\pmb{X})&= \frac{\partial f(\pmb{X})}{\partial \text{vec}\pmb{X}} \\\\ &= \left[ \frac{\partial f}{\partial x_{11}},\frac{\partial f}{\partial x_{21}},\cdots,\frac{\partial f}{\partial x_{m1}},\frac{\partial f}{\partial x_{12}},\frac{\partial f}{\partial x_{22}},\cdots,\frac{\partial f}{\partial x_{m2}},\cdots,\frac{\partial f} {\partial x_{1n}},\frac{\partial f}{\partial x_{2n}},\cdots,\frac{\partial f}{\partial  x_{mn}} \right]^T \end{align*} \\\\  \tag{10}
$$

#### 2.4 梯度矩阵形式

直接对原矩阵变元 $\pmb{X}$ 的每个位置的元素逐个求导, 结果布局和原矩阵布局一样。

$$
\begin{align*} \nabla_{\pmb{X}}f(\pmb{X})&= \frac{\partial f(\pmb{X})}{\partial \pmb{X}_{m\times n}} \\\\ &= \left[  \matrix{ \frac{\partial f}{\partial x_{11}}&\frac{\partial f}{\partial x_{12}}&\cdots&\frac{\partial f}{\partial x_{1n}} \\ \frac{\partial f}{\partial x_{21}}&\frac{\partial f}{\partial x_{22}}& \cdots & \frac{\partial f}{\partial x_{2n}}\\ \vdots&\vdots&\vdots&\vdots\\ \frac{\partial f} {\partial x_{m1}}&\frac{\partial f}{\partial x_{m2}}&\cdots&\frac{\partial f}{\partial  x_{mn}} } \right]_{m\times n} \end{align*} \\\\  \tag{11}
$$

#### 2.5 一些发现

##### 2.5.1 转置

**$(9)$  式与 $(11)$ 式互为转置**； $(8)$  式与 $(10)$ 式互为转置。

##### 2.5.2 相等

当**矩阵**变元 $\pmb{X}$ 本身就是一个**列向量** $\pmb{x}=[x_1,x_2,\cdots ,x_n]^T$ 时, $(5)$ 式、 $(8)$ 式、 $(9)$ 式**相等**; $(6)$ 式、$(10)$ 式、$(11)$ 式**相等**; 当然, 前三个式子与后三个式子**互为转置**。

这一发现说明，对于**向量**变元的**实值标量函数** $f(\pmb {x})$ , $\pmb{x}=[x_1,x_2,\cdots ,x_n]^T$ , 结果布局本质上有两种形式，一种是 $\text{Jacobian}$ 矩阵（**已经成行向量了**）形式，一种是**梯度矩阵（已经成列向量了）**形式。两种形式**互为转置**。

<br>

**后面第三大块<u>矩阵变元的实矩阵函数, 暂时用不到</u>，所以就不记了。要用的时候再说。**



## 四. 分子布局、分母布局的本质

看到这里，相信同学们对矩阵求导结果的布局有了很全面的了解了，无非就是**分子的转置、向量化，分母的转置、向量化**，它们的**各种组合**而已。

结合上述知识，我们总结：

1、**分子布局的本质**：分子是**标量、列向量**、矩阵向量化后的**列向量**；分母是**标量**、列向量转置后的**行向量**、矩阵的**转置**矩阵、矩阵向量化后的列向量转置后的**行向量**。

2、**分母布局的本质**：分子是**标量**、列向量**转置**后的**行向量**、矩阵向量化后的列向量**转置**后的**行向量**；分母是**标量、列向量、矩阵自己**、矩阵向量化后的**列向量**。

思考一下，其实我们可以再简洁一些：**谁转置了，就是另一方的布局**。分子转置了，就是分母布局；分母转置了，就是分子布局。


